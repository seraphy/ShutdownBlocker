Shutdown Blocker
=================

目的・機能
-----------
ShutdownBlocker.exeは、Windows7(Vista以降)のログオフ、リブート、シャットダウンの実行をブロックするための常駐アプリケーションです。

(このシャットダウンブロッキングの仕組みはVistaから採用されたものでXPには機能しませんし動作しません。)



使い方
-----------

### シャットダウンレベル

ログオフ、リブート、シャットダウンのイベントによって起動中のアプリケーションが一斉に閉じられるとき、
アプリケーションごとに、他のアプリケーションとの閉じる順序を相対的に指定することができます。

レベルは16進数で指定し、**100～3ff(4ff)** の範囲で指定することができます。

数値が大きいほど早い段階でシャットダウンの要求が発生します。

[SetProcessShutdownParameters Function]
(http://msdn.microsoft.com/en-us/library/windows/desktop/ms686227.aspx)

- 本アプリの優先度を高く(**4ff**とか)することで、他のアプリケーションにシャットダウンの指示が出る前に、
シャットダウンをブロッキングすることができます。
- この数値を **100** ぐらいに低くすることで、アプリケーションのシャットダウンは行うがシステムは実際にはシャットダウンさせたくない、というような(アプリケーションのシャットダウンのテストなど)使い方をすることができます。


### シャットダウンの理由

シャットダウンをブロッキングする場合、Windowsに対してブロッキングする理由を指示する必要があります。

これはログオフ、リブート、シャットダウンの実施中に、シャットダウンを妨げているアプリケーション名とともに、
その理由が表示される場合に用いられるものです。

[ShutdownBlockReasonCreate Function]
(http://msdn.microsoft.com/en-us/library/windows/desktop/aa376877.aspx)


ビルド方法
------------

### Visual Studio 2012 Express For Desktop

本アプリケーションは「VS Express for Desktop (2012 Update3)」のVisual C++で作成されています。

ただし、VS Expressにはリソースエディタがないため、リソースエディタとして [**ResEdit**]
(http://www.resedit.net/) を用いています。


生成されたrcファイル中に不要なインクルードがあるため、これはRedEdit保存後に手作業で除去しています。

※ 除去せずとも正常にコンパイルされます。ただし、シンボルが長すぎるなどの警告メッセージが出ます。


参考URL、基本アイディア(仕組み)
------------

シャットダウンをブロッキングするための仕組みについては、

[DOBON.NETプログラミング掲示板過去ログの「スタートメニューの電源ボタン押下のイベント取得方法」]
(http://dobon.net/vb/bbs/log3-36/22254.html)

のアイディアをいただいております。

この方法でWindows7(SP1 x64)のシャットダウンは、うまくブロッキングしてくれています。


※ シャットダウンまわりの仕様は2000からXPに移行したとき、XPからVistaに移行したとき、など、
時代によって変わってきたので、この方法がいつまで使えるかはわかりません。(念のため)


ライセンス
-----------
本アプリケーションはオープンソースのMITライセンスとします。

